<script>
    import mapboxgl from 'mapbox-gl';
    import { onMount, onDestroy } from 'svelte';

    const user = JSON.parse(sessionStorage.getItem('user'));

    let mapContainer;
    let startTime;
    let paused = true;
    let pauseTime = Date.now();
    let interval;

    // just fill this in with actual route info I guess
    let geojson = `
    {
        "coordinates": [[-79.93345, 40.45125], [-79.93339, 40.45126], [-79.93297, 40.4514], [-79.933, 40.45147], [-79.933, 40.45147], [-79.93321, 40.45185], [-79.9334, 40.45218], [-79.93371, 40.45276], [-79.93385, 40.45303], [-79.93398, 40.45329], [-79.93403, 40.45336], [-79.93422, 40.45369], [-79.93431, 40.45385], [-79.93435, 40.45392], [-79.93435, 40.45392], [-79.93361, 40.45428], [-79.9335, 40.45433], [-79.93323, 40.45446], [-79.93262, 40.45476], [-79.93261, 40.45477], [-79.93323, 40.45446], [-79.9335, 40.45433], [-79.93361, 40.45428], [-79.93435, 40.45392], [-79.93479, 40.45371], [-79.93522, 40.45351], [-79.93561, 40.45332], [-79.9359, 40.45319], [-79.936, 40.45314], [-79.9367, 40.45279], [-79.93666, 40.45272], [-79.93666, 40.45272], [-79.93649, 40.45243], [-79.93618, 40.45189], [-79.9357, 40.45106], [-79.93559, 40.45087], [-79.93548, 40.45069], [-79.93545, 40.45062], [-79.93533, 40.45042], [-79.93526, 40.45029], [-79.93508, 40.44999], [-79.93497, 40.44978], [-79.93458, 40.4491], [-79.93449, 40.44896], [-79.93447, 40.44893], [-79.93447, 40.44893], [-79.93419, 40.44845], [-79.93415, 40.44838], [-79.93419, 40.44837], [-79.93419, 40.44837], [-79.93475, 40.44819], [-79.93525, 40.44803], [-79.93566, 40.4479], [-79.93571, 40.44789], [-79.93573, 40.44788], [-79.93575, 40.44788], [-79.93579, 40.44788], [-79.93588, 40.44787], [-79.93608, 40.44785], [-79.93617, 40.44785], [-79.93706, 40.44778], [-79.93717, 40.44778], [-79.93882, 40.44766], [-79.94093, 40.4475], [-79.9424, 40.44741], [-79.94249, 40.4474], [-79.94249, 40.4474], [-79.94244, 40.44715], [-79.94238, 40.44675], [-79.94238, 40.44675], [-79.94241, 40.44674], [-79.94243, 40.44673], [-79.94249, 40.44671], [-79.94259, 40.44668], [-79.94272, 40.44662], [-79.94287, 40.44656], [-79.94289, 40.44655], [-79.94291, 40.44653], [-79.94291, 40.44651], [-79.94291, 40.44644], [-79.9429, 40.44636], [-79.94291, 40.44633], [-79.94291, 40.44629], [-79.94292, 40.44622], [-79.94291, 40.44614], [-79.94293, 40.44606], [-79.94295, 40.446], [-79.94298, 40.44597], [-79.94298, 40.44597], [-79.94305, 40.44597], [-79.94313, 40.44595], [-79.94318, 40.44592], [-79.94324, 40.44589], [-79.94329, 40.44584], [-79.94353, 40.44545], [-79.94366, 40.44525], [-79.94371, 40.44519], [-79.94371, 40.44519], [-79.94364, 40.44506], [-79.94363, 40.44503], [-79.94363, 40.44501], [-79.94363, 40.44499], [-79.94363, 40.44496], [-79.94362, 40.44495], [-79.9436, 40.44493], [-79.94357, 40.44492], [-79.94357, 40.44492], [-79.94361, 40.44486], [-79.9437, 40.44477], [-79.94379, 40.44467], [-79.94383, 40.44467], [-79.94383, 40.44467], [-79.94398, 40.44467], [-79.94433, 40.44465], [-79.94439, 40.44465], [-79.94474, 40.44463], [-79.94494, 40.44462], [-79.94564, 40.44459], [-79.94605, 40.44458], [-79.94625, 40.44457], [-79.94626, 40.4445], [-79.94628, 40.4445], [-79.94644, 40.44449], [-79.94657, 40.44449], [-79.94659, 40.44449], [-79.94674, 40.44448], [-79.94675, 40.44448], [-79.94677, 40.44448], [-79.94704, 40.44447], [-79.94751, 40.44445], [-79.94776, 40.44444], [-79.94804, 40.44443], [-79.94867, 40.4444], [-79.94926, 40.44425], [-79.94939, 40.44422], [-79.94942, 40.44421], [-79.94961, 40.44417], [-79.94974, 40.44413], [-79.95021, 40.44402], [-79.95045, 40.44395], [-79.95072, 40.44388], [-79.95094, 40.44382], [-79.951, 40.4438], [-79.95121, 40.44375], [-79.95166, 40.44363], [-79.95166, 40.44363], [-79.95163, 40.44356], [-79.95163, 40.44356], [-79.95165, 40.44352], [-79.95169, 40.44348], [-79.95177, 40.44342], [-79.95193, 40.44327], [-79.95201, 40.44325], [-79.95201, 40.44325], [-79.95175, 40.44269], [-79.95168, 40.44253], [-79.95167, 40.44246], [-79.95168, 40.44241], [-79.9517, 40.44234], [-79.9517, 40.44234], [-79.95181, 40.44235], [-79.95183, 40.44235], [-79.95191, 40.44235], [-79.95197, 40.44234], [-79.95203, 40.44233], [-79.95207, 40.44232], [-79.95209, 40.44232], [-79.95212, 40.44231], [-79.95215, 40.44229], [-79.95221, 40.44225], [-79.95225, 40.44223], [-79.95228, 40.44219], [-79.95233, 40.44215], [-79.95238, 40.44211], [-79.95241, 40.44206], [-79.95246, 40.442], [-79.95251, 40.44194], [-79.95256, 40.44188], [-79.95261, 40.4418], [-79.95267, 40.44178], [-79.95267, 40.44178], [-79.95282, 40.44153], [-79.95286, 40.44147], [-79.9529, 40.44143], [-79.95293, 40.44139], [-79.95297, 40.44136], [-79.95302, 40.44132], [-79.95307, 40.44129], [-79.95311, 40.44128], [-79.95312, 40.44127], [-79.95317, 40.44125], [-79.95321, 40.44123], [-79.95329, 40.44121], [-79.95332, 40.4412], [-79.95355, 40.44115], [-79.95364, 40.44112], [-79.95377, 40.44109], [-79.95394, 40.44104], [-79.95401, 40.44102], [-79.95407, 40.441], [-79.95413, 40.44097], [-79.95416, 40.44095], [-79.95418, 40.44094], [-79.95433, 40.44084], [-79.95433, 40.44084], [-79.95448, 40.44092], [-79.95448, 40.44092], [-79.95433, 40.44084], [-79.95433, 40.44084], [-79.95418, 40.44094], [-79.95416, 40.44095], [-79.95413, 40.44097], [-79.95407, 40.441], [-79.95401, 40.44102], [-79.95394, 40.44104], [-79.95377, 40.44109], [-79.95364, 40.44112], [-79.95355, 40.44115], [-79.95332, 40.4412], [-79.95329, 40.44121], [-79.95321, 40.44123], [-79.95317, 40.44125], [-79.95312, 40.44127], [-79.95311, 40.44128], [-79.95307, 40.44129], [-79.95302, 40.44132], [-79.95297, 40.44136], [-79.95293, 40.44139], [-79.9529, 40.44143], [-79.95286, 40.44147], [-79.95282, 40.44153], [-79.95267, 40.44178], [-79.95267, 40.44186], [-79.95267, 40.44186], [-79.95271, 40.44198], [-79.9527, 40.44208], [-79.95269, 40.44213], [-79.95274, 40.44238], [-79.95276, 40.44246], [-79.95282, 40.4426], [-79.95282, 40.4426], [-79.95272, 40.44268], [-79.95272, 40.44268], [-79.95281, 40.44275], [-79.95307, 40.44298], [-79.95307, 40.44298], [-79.95297, 40.443], [-79.9529, 40.44302], [-79.9529, 40.44302], [-79.95293, 40.44311], [-79.95294, 40.44313], [-79.95294, 40.44313], [-79.95289, 40.44315], [-79.95289, 40.44315], [-79.9529, 40.44317], [-79.95292, 40.44322], [-79.95292, 40.44322], [-79.9527, 40.44328], [-79.95261, 40.44331], [-79.95249, 40.44333], [-79.95247, 40.44335], [-79.95238, 40.44337], [-79.9522, 40.44342], [-79.9522, 40.44342], [-79.95223, 40.44348], [-79.95223, 40.44348], [-79.95212, 40.44351], [-79.95166, 40.44363], [-79.95121, 40.44375], [-79.951, 40.4438], [-79.95094, 40.44382], [-79.95072, 40.44388], [-79.95045, 40.44395], [-79.95021, 40.44402], [-79.94974, 40.44413], [-79.94961, 40.44417], [-79.94942, 40.44421], [-79.94939, 40.44422], [-79.94926, 40.44425], [-79.94867, 40.4444], [-79.94804, 40.44443], [-79.94776, 40.44444], [-79.94751, 40.44445], [-79.94704, 40.44447], [-79.94677, 40.44448], [-79.94675, 40.44448], [-79.94674, 40.44448], [-79.94659, 40.44449], [-79.94657, 40.44449], [-79.94644, 40.44449], [-79.94628, 40.4445], [-79.94626, 40.4445], [-79.94624, 40.4445], [-79.94604, 40.4445], [-79.94563, 40.44452], [-79.94493, 40.44454], [-79.94474, 40.44456], [-79.9444, 40.44457], [-79.9444, 40.44457], [-79.94442, 40.44451], [-79.94444, 40.44443], [-79.94444, 40.44442], [-79.94447, 40.44437], [-79.94448, 40.44433], [-79.94448, 40.44429], [-79.94448, 40.44427], [-79.94447, 40.44426], [-79.94446, 40.44424], [-79.94443, 40.44421], [-79.9444, 40.44418], [-79.94433, 40.44416], [-79.94427, 40.44415], [-79.94422, 40.44413], [-79.94418, 40.44412], [-79.94411, 40.4441], [-79.94401, 40.44405], [-79.94389, 40.44399], [-79.9438, 40.44395], [-79.9438, 40.44395], [-79.94375, 40.44402], [-79.94366, 40.444], [-79.94366, 40.444], [-79.94351, 40.44397], [-79.94343, 40.44395], [-79.94316, 40.44389], [-79.94307, 40.44387], [-79.94285, 40.44382], [-79.94239, 40.44371]],
        "type": "LineString"
      }
    `;
    let route = {
      name: 'Wow a route',
      elapsed: 0,
      distance: 0,
      route: geojson,
    }
    
    onMount(async () => {
      startTime = new Date();
      const map = new mapboxgl.Map({
        container: mapContainer,
        style: 'mapbox://styles/mapbox/streets-v11',
        accessToken: 'pk.eyJ1IjoiYWlzNzYiLCJhIjoiY2tseDNiMHM4MDB5eTJ2cnM0YnZsdTQ0cSJ9.o3Bh8gznViclDtI-zg6t5g',
        zoom: 12,
        center: [-79.93345, 40.45125],
        attributionControl: false
      });
      map.on('load', () => {
        map.addSource('route', {
          'type': 'geojson',
          'data': JSON.parse(route.route),
        });
        map.addLayer({
            'id': 'route',
            'type': 'line',
            'source': 'route',
            'layout': {
              'line-join': 'round',
              'line-cap': 'round'
            },
            'paint': {
              'line-color': '#F4A261',
              'line-width': 4
            }
        });
      });
      interval = setInterval(() => {
        if (!paused) {
          route.elapsed = Date.now() - startTime;
        }
      }, 1000);
	});
    function prettyTime(ms) {
      let secs = ms / 1000;
      ms = Math.floor(ms % 1000);
      let minutes = secs / 60;
      secs = Math.floor(secs % 60).toString().padStart(2, '0');
      let hours = minutes / 60;
      minutes = Math.floor(minutes % 60).toString().padStart(2, '0');
      hours = Math.floor(hours % 24).toString().padStart(2, '0');
      return hours + ":" + minutes + ":" + secs;  
    }
    function togglePaused() {
      if (paused) {
        startTime = new Date(startTime.getTime() + (Date.now() - pauseTime));
        paused = false;
      } else {
        pauseTime = Date.now();
        paused = true;
      }
    }
    onDestroy(() => {
      clearInterval(interval);
	});
</script>

<style>
  #map {
    height: 100vh;
  }
  main {
    z-index: 1;
    position: relative;
  }
  #top {
    position: absolute;
    background-color: $jade;
    width: 100%;
    color: white;
    border-radius: 0 0 $radius $radius;
    padding: 0.5rem 1rem;
    box-sizing: border-box;
    display: grid;
    grid-template-columns: auto 1fr;
    grid-gap: 1rem;
    box-shadow: $shadow;
    a {
      justify-self: end;
      align-self: center;
      img {
        max-height: 4rem;
        border-radius: $radius;
      }
    }
  }
  #info {
    position: fixed;
    bottom: 0;
    background-color: white;
    margin: 1rem;
    border-radius: $radius;
    width: calc(100% - 2rem);
    box-sizing: border-box;
    display: grid;
    grid-template-columns: auto auto;
    padding-top: 1.5rem;
    box-shadow: $shadow;
    p {
      text-align: center;
      font-size: 24px;
    }
    #controls {
      position: absolute;
      top: -2.5rem;
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      width: 100%;
      max-width: 20rem;
      margin: 0 auto;
      box-sizing: border-box;
      left: 50%;
      transform: translateX(-50%);
      place-items: center;
      .circle {
        box-shadow: $shadow;
        border-radius: 50%;
        border: 5px solid $orange;
        width: 3.5rem;
        background-color: white;
        height: 3.5rem;
        display: flex;
        justify-content: center;
        align-items: center;
        img {
          width: 2.25rem;
          height: 2.25rem;
        }
      }
      #pause {
        box-shadow: $shadow;
        cursor: pointer;
        width: 5rem;
        height: 5rem;
        background-color: $orange;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        img {
          width: 2.5rem;
          height: 2.5rem;
        }
      }
    }
  }
</style>

<main>
  <div id="top">
    <h1>{route.name}</h1>
    <a href="/profile"><img src={user.picture} alt={user.name}></a>
  </div>
  <div id="info">
    <p id="time">{prettyTime(route.elapsed)}</p>
    <p id="distance">{route.distance + 'km'}</p>
    <div id="controls">
      <div id="restart" class="circle">
        <img src="/images/vector/redo.svg" alt="Redo"/>
      </div>
      <div id="pause" on:click={togglePaused}>
        {#if paused}
          <img src="/images/vector/play.svg" alt="Start"/>
        {:else}
          <img src="/images/vector/pause.svg" alt="Pause"/>
        {/if}
      </div>
      <a id="check" class="circle" href="/welcome">
        <img src="/images/vector/check.svg" alt="Complete"/>
      </a>
    </div>
  </div>
</main>
<div id="map" bind:this={mapContainer}></div>

